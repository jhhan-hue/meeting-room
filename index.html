<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>íšŒì˜ì‹¤ ì˜ˆì•½ (Aâ€“E, 30ë¶„ ë‹¨ìœ„)</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --danger:#ef4444;
      --border:#1f2937;
      --slot:#0b1224;
      --slot-alt:#0d152b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1630);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(10,15,30,.8);backdrop-filter:saturate(140%) blur(10px);z-index:10}
    h1{margin:0;font-weight:700;font-size:20px;letter-spacing:.2px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .toolbar > *{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px;line-height:1;display:flex;align-items:center;gap:8px}
    input,select,button,textarea{font:inherit}
    button{cursor:pointer}
    button.primary{background:var(--accent);border:none;color:#052e16}
    button.ghost{background:transparent;border:1px solid var(--border)}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .grid-wrap{overflow:auto;border:1px solid var(--border);border-radius:14px}
    .grid{display:grid;min-width:900px}
    .grid .head{position:sticky;top:0;background:#0b1224;z-index:5}
    .cell{padding:10px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);min-height:42px}
    .time-col{width:90px;position:sticky;left:0;z-index:4;background:linear-gradient(180deg,#0b1224,#0b1224)}
    .room-head{font-weight:700;text-align:center}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:#0e1a36;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .legend{display:flex;gap:12px;align-items:center;margin-left:auto}
    .resv{background:linear-gradient(180deg,#052e16,#06331a);border:1px solid #14532d;color:#eafff0;border-radius:10px;padding:6px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px;height:100%}
    .resv .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .resv small{color:#c7f9d5}
    .slot{background:transparent}
    .slot:hover{background:#0f1b36}
    .row-alt{background:var(--slot-alt)}
    .row{background:var(--slot)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:560px;width:95%;padding:16px}
    .modal h3{margin:0 0 8px 0}
    .f{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin:8px 0}
    .f input,.f select,.f textarea{background:#0a1328;border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text)}
    .f textarea{min-height:74px;resize:vertical}
    .modal .row-btns{display:flex;gap:8px;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
    .left-btns,.right-btns{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px dashed var(--border);padding:8px 10px;border-radius:10px;color:var(--muted);font-size:12px}
    .footer{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1224;border:1px solid var(--border);padding:12px 14px;border-radius:12px;display:none;z-index:60}
    .hint{color:var(--muted);font-size:12px}
    a.link{color:#7dd3fc;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <h1>íšŒì˜ì‹¤ ì˜ˆì•½ (Rooms Aâ€“E, 30ë¶„ ë‹¨ìœ„)</h1>
    <div class="toolbar">
      <label class="badge">
        ë‚ ì§œ
        <input type="date" id="datePicker">
      </label>
      <label class="badge">
        ì‹œì‘
        <select id="startHour"></select>
      </label>
      <label class="badge">
        ì¢…ë£Œ
        <select id="endHour"></select>
      </label>
      <button class="primary" id="newBtn">+ ìƒˆ ì˜ˆì•½</button>
      <button class="ghost" id="exportBtn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
      <button class="ghost" id="importBtn">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
      <button class="ghost" id="icsDayBtn">ì˜¤ëŠ˜(í‘œì‹œì¼) .ics ë‚´ë³´ë‚´ê¸°</button>
      <div class="legend">
        <span class="badge">A</span>
        <span class="badge">B</span>
        <span class="badge">C</span>
        <span class="badge">D</span>
        <span class="badge">E</span>
      </div>
    </div>
  </header>

  <main>
    <div class="grid-wrap">
      <div id="grid" class="grid"></div>
    </div>
    <div class="footer">
      <span class="pill">ë¸Œë¼ìš°ì €(LocalStorage)ì— ì €ì¥ë©ë‹ˆë‹¤. íŒ€ê³¼ ê³µìœ í•˜ë ¤ë©´ JSON/ICSë¡œ ë‚´ë³´ë‚´ê±°ë‚˜, ì´ íŒŒì¼ì„ ê°„ë‹¨í•œ í˜¸ìŠ¤íŒ…(GitHub Pages/Netlify ë“±)ì— ì˜¬ë ¤ URLì„ ê³µìœ í•˜ì„¸ìš”.</span>
      <span class="hint">ì¤‘ë³µ ì˜ˆì•½ ìë™ ë°©ì§€ Â· í´ë¦­ìœ¼ë¡œ í¸ì§‘/ì‚­ì œ Â· Google ìº˜ë¦°ë” ì¶”ê°€/ICS ì§€ì›</span>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalWrap" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">ìƒˆ ì˜ˆì•½</h3>
      <div class="f"><label>ë°©</label><select id="fRoom"></select></div>
      <div class="f"><label>ë‚ ì§œ</label><input type="date" id="fDate"></div>
      <div class="f"><label>ì‹œì‘</label><select id="fStart"></select></div>
      <div class="f"><label>ê¸¸ì´</label><select id="fDur"></select></div>
      <div class="f"><label>ì œëª©</label><input id="fTitle" placeholder="ì˜ˆ: ì£¼ê°„ ì •ê¸°íšŒì˜"></div>
      <div class="f"><label>ë¶€ì„œ</label><input id="fDept" placeholder="ì˜ˆ: ì¼ë³¸íŒ€ / ì˜ì—…1ë³¸ë¶€"></div>
      <div class="f"><label>ì£¼ìµœì</label><input id="fOwner" placeholder="ì˜ˆ: ì§€í˜„"></div>
      <div class="f"><label>ë©”ëª¨</label><textarea id="fNote" placeholder="í•„ìš” ì¥ë¹„, ì°¸ì„ì ë“±"></textarea></div>
      <div class="row-btns">
        <div class="left-btns">
          <button class="ghost" id="delBtn" style="display:none;color:#ef4444;border-color:#3f1d1d">ì‚­ì œ</button>
        </div>
        <div class="right-btns">
          <button class="ghost" id="gcalBtn" title="Google ìº˜ë¦°ë”ë¡œ ì¶”ê°€" style="display:none">Google ìº˜ë¦°ë”</button>
          <button class="ghost" id="icsBtn" title="ì´ ì˜ˆì•½ .ics ì €ì¥" style="display:none">ICS ì €ì¥</button>
          <button class="ghost" id="cancelBtn">ì·¨ì†Œ</button>
          <button class="primary" id="saveBtn">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const ROOMS = ["A","B","C","D","E"];
    const SLOT_MINUTES = 30;
    const DEFAULT_START = 8;
    const DEFAULT_END = 20;
    const STORAGE_KEY = "roomResv_v2";

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const pad = n => String(n).padStart(2,'0');

    function toKey(dateStr){ return dateStr; }
    function toSlotIndex(h, m){ return h*60/SLOT_MINUTES + Math.floor(m/SLOT_MINUTES); }
    function fromSlotIndex(idx){ const total = idx*SLOT_MINUTES; return {h:Math.floor(total/60), m: total%60}; }
    function fmtHM(h,m){ return pad(h)+":"+pad(m); }
    function showToast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1400); }

    function loadData(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch{ return {}; }
    }
    function saveData(data){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    const state = {
      startHour: DEFAULT_START,
      endHour: DEFAULT_END,
      date: new Date(),
      data: loadData(),
      editing: null
    };

    function ymd(d){
      const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return tz.toISOString().slice(0,10);
    }
    function parseYMD(dateStr){
      const [y,mo,da]=dateStr.split("-").map(Number);
      return new Date(y,mo-1,da);
    }
    function toLocalDate(dateStr, h, m){
      const d = parseYMD(dateStr);
      d.setHours(h, m, 0, 0);
      return d;
    }
    function fmtGCalDateTime(d){
      const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      const s = z.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z");
      return s;
    }
    function buildGCalUrl(resv){
      const startHM = fromSlotIndex(resv.start);
      const endHM = fromSlotIndex(resv.start + resv.slots);
      const start = toLocalDate(resv.date, startHM.h, startHM.m);
      const end = toLocalDate(resv.date, endHM.h, endHM.m);
      const dates = fmtGCalDateTime(start) + "/" + fmtGCalDateTime(end);
      const text = encodeURIComponent(resv.title || "(ì œëª© ì—†ìŒ)");
      const location = encodeURIComponent(`íšŒì˜ì‹¤ ${resv.room}`);
      const details = encodeURIComponent(
        [
          resv.dept ? `ë¶€ì„œ: ${resv.dept}` : "",
          resv.owner ? `ì£¼ìµœì: ${resv.owner}` : "",
          resv.note ? `ë©”ëª¨: ${resv.note}` : ""
        ].filter(Boolean).join("\\n")
      );
      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&location=${location}&details=${details}`;
    }
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
    }
    function uid(){ return Math.random().toString(36).slice(2,10); }

    function foldLine(line){
      if(line.length <= 70) return line;
      let out = "";
      while(line.length > 70){
        out += line.slice(0,70) + "\\r\\n ";
        line = line.slice(70);
      }
      return out + line;
    }
    function formatICSDateLocal(d){
      const y = d.getFullYear();
      const mo = pad(d.getMonth()+1);
      const da = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      const ss = "00";
      return `${y}${mo}${da}T${hh}${mi}${ss}`;
    }
    function escapeICS(s){
      return String(s||"").replace(/([,;])/g,"\\$1").replace(/\\n/g,"\\n").replace(/\\r?\\n/g,"\\n");
    }
    function makeICSEvent(resv){
      const startHM = fromSlotIndex(resv.start);
      const endHM = fromSlotIndex(resv.start + resv.slots);
      const start = toLocalDate(resv.date, startHM.h, startHM.m);
      const end = toLocalDate(resv.date, endHM.h, endHM.m);
      const lines = [
        "BEGIN:VEVENT",
        `UID:${resv.id || uid()}@local`,
        `DTSTAMP:${formatICSDateLocal(new Date())}`,
        `DTSTART:${formatICSDateLocal(start)}`,
        `DTEND:${formatICSDateLocal(end)}`,
        `SUMMARY:${escapeICS(resv.title || "(ì œëª© ì—†ìŒ)")}`,
        `LOCATION:${escapeICS("íšŒì˜ì‹¤ " + resv.room)}`,
        `DESCRIPTION:${escapeICS(
          [
            resv.dept ? `ë¶€ì„œ: ${resv.dept}` : "",
            resv.owner ? `ì£¼ìµœì: ${resv.owner}` : "",
            resv.note ? `ë©”ëª¨: ${resv.note}` : ""
          ].filter(Boolean).join("\\n")
        )}`,
        "END:VEVENT"
      ];
      return lines.map(foldLine).join("\\r\\n");
    }
    function downloadICS(filename, events){
      const header = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//FNL//Room Booking//KO",
        "CALSCALE:GREGORIAN",
        "METHOD:PUBLISH"
      ].join("\\r\\n");
      const body = events.join("\\r\\n");
      const footer = "END:VCALENDAR";
      const ics = header + "\\r\\n" + body + "\\r\\n" + footer;
      const blob = new Blob([ics], {type:"text/calendar"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function initControls(){
      const dp = $("#datePicker");
      dp.value = ymd(state.date);
      dp.addEventListener("change", ()=>{ state.date = new Date(dp.value+"T00:00:00"); renderGrid(); });

      const sh = $("#startHour"), eh=$("#endHour");
      for(let h=0; h<=23; h++){
        const o1 = document.createElement("option"); o1.value=h; o1.textContent=pad(h)+":00"; if(h===state.startHour) o1.selected=true; sh.appendChild(o1);
        const o2 = document.createElement("option"); o2.value=h; o2.textContent=pad(h)+":00"; if(h===state.endHour) o2.selected=true; eh.appendChild(o2);
      }
      sh.addEventListener("change", ()=>{ state.startHour=+sh.value; renderGrid(); });
      eh.addEventListener("change", ()=>{ state.endHour=Math.max(+eh.value, state.startHour+1); eh.value=state.endHour; renderGrid(); });

      $("#newBtn").addEventListener("click", ()=> openModal());
      $("#exportBtn").addEventListener("click", doExport);
      $("#importBtn").addEventListener("click", ()=> $("#importFile").click());
      $("#importFile").addEventListener("change", doImport);
      $("#icsDayBtn").addEventListener("click", exportDayICS);
    }

    function getDayList(key){
      return state.data[key] || [];
    }
    function setDayList(key, list){
      state.data[key] = list;
      saveData(state.data);
    }
    function genId(){ return Math.random().toString(36).slice(2,10); }

    function overlaps(resv, others){
      const start = resv.start;
      const end = start + resv.slots;
      return others.some(r=> r.room===resv.room && !(end<=r.start || start>=r.start+r.slots) && r.id!==resv.id);
    }

    function renderGrid(){
      const key = toKey(ymd(state.date));
      const list = getDayList(key);
      const grid = $("#grid");
      const hours = [];
      for(let h=state.startHour; h<state.endHour; h++){
        hours.push(h);
      }

      grid.style.gridTemplateColumns = `90px repeat(${ROOMS.length}, 1fr)`;

      grid.innerHTML = "";
      const headTime = div("cell head time-col"); headTime.textContent="ì‹œê°„/ë°©"; grid.appendChild(headTime);
      for(const r of ROOMS){
        const h = div("cell head room-head"); h.textContent=r; grid.appendChild(h);
      }

      let rowIndex = 0;
      for(const h of hours){
        for(let s=0; s<60/SLOT_MINUTES; s++){
          const idx = toSlotIndex(h, s*SLOT_MINUTES);
          const rowClass = (rowIndex%2===0?"row":"row-alt");
          const tc = div(`cell time-col ${rowClass}`);
          tc.textContent = fmtHM(h, s*SLOT_MINUTES);
          grid.appendChild(tc);
          for(const room of ROOMS){
            const cell = div(`cell ${rowClass} slot`);
            cell.dataset.slot = idx;
            cell.dataset.room = room;
            cell.addEventListener("click", (e)=>{
              if(e.target.closest(".resv")) return;
              openModal({room, start: idx});
            });
            grid.appendChild(cell);
          }
          rowIndex++;
        }
      }

      for(const r of list){
        const selector = `.cell.slot[data-room="${r.room}"][data-slot="${r.start}"]`;
        const startCell = grid.querySelector(selector);
        if(!startCell) continue;
        const el = renderReservationElement(r);
        el.style.gridRow = `span ${r.slots}`;
        startCell.style.position="relative";
        startCell.appendChild(el);

        for(let i=1;i<r.slots;i++){
          const coveredSel = `.cell.slot[data-room="${r.room}"][data-slot="${r.start+i}"]`;
          const covered = grid.querySelector(coveredSel);
          if(covered){
            covered.style.background="transparent";
            covered.dataset.covered="1";
          }
        }
      }
    }

    function renderReservationElement(r){
      const el = div("resv");
      const left = div();
      const startHM = fromSlotIndex(r.start);
      const endHM = fromSlotIndex(r.start + r.slots);
      left.innerHTML = `<div class="title">${escapeHtml(r.title||"(ì œëª© ì—†ìŒ)")}</div>
                        <small>${r.room} â€¢ ${fmtHM(startHM.h,startHM.m)} ~ ${fmtHM(endHM.h,endHM.m)}${r.dept ? " â€¢ "+escapeHtml(r.dept) : ""}${r.owner ? " â€¢ "+escapeHtml(r.owner) : ""}</small>`;
      const right = div();
      const editBtn = document.createElement("button"); editBtn.textContent="í¸ì§‘"; editBtn.className="ghost"; editBtn.style.padding="6px 8px";
      editBtn.addEventListener("click", (e)=>{ e.stopPropagation(); openModal(null, r.id); });
      const gcalBtn = document.createElement("button"); gcalBtn.textContent="GCal"; gcalBtn.className="ghost"; gcalBtn.style.padding="6px 8px";
      gcalBtn.addEventListener("click", (e)=>{ e.stopPropagation(); window.open(buildGCalUrl(r), "_blank"); });
      const icsBtn = document.createElement("button"); icsBtn.textContent="ICS"; icsBtn.className="ghost"; icsBtn.style.padding="6px 8px";
      icsBtn.addEventListener("click", (e)=>{ e.stopPropagation(); downloadICS(`reservation_${r.id||"event"}.ics`, [makeICSEvent(r)]); });
      right.appendChild(gcalBtn);
      right.appendChild(icsBtn);
      right.appendChild(editBtn);
      el.appendChild(left); el.appendChild(right);
      el.addEventListener("click", (e)=>{ e.stopPropagation(); openModal(null, r.id); });
      return el;
    }

    function openModal(preset=null, id=null){
      const wrap=$("#modalWrap");
      wrap.style.display="flex";
      $("#modalTitle").textContent = id ? "ì˜ˆì•½ í¸ì§‘" : "ìƒˆ ì˜ˆì•½";

      const roomSel=$("#fRoom");
      roomSel.innerHTML="";
      ROOMS.forEach(r=>{ const o=document.createElement("option"); o.value=r; o.textContent=r; roomSel.appendChild(o); });

      $("#fDate").value = ymd(state.date);

      const fStart=$("#fStart"), fDur=$("#fDur");
      fStart.innerHTML=""; fDur.innerHTML="";
      const startHour = state.startHour, endHour = state.endHour;
      for(let h=startHour; h<endHour; h++){
        for(let m=0; m<60; m+=SLOT_MINUTES){
          const idx = toSlotIndex(h,m);
          const o = document.createElement("option");
          o.value=idx; o.textContent = fmtHM(h,m);
          fStart.appendChild(o);
        }
      }
      for(let s=1; s<=8; s++){
        const o=document.createElement("option"); o.value=s; o.textContent=(s*30)+"ë¶„"; fDur.appendChild(o);
      }

      $("#fTitle").value="";
      $("#fDept").value="";
      $("#fOwner").value="";
      $("#fNote").value="";
      $("#delBtn").style.display = id ? "inline-flex" : "none";
      $("#gcalBtn").style.display = id ? "inline-flex" : "none";
      $("#icsBtn").style.display = id ? "inline-flex" : "none";

      if(preset){
        roomSel.value = preset.room || ROOMS[0];
        fStart.value = String(preset.start ?? toSlotIndex(startHour,0));
      }
      if(id){
        const key = toKey($("#fDate").value);
        const list = getDayList(key);
        const found = list.find(x=>x.id===id);
        if(found){
          state.editing = id;
          roomSel.value = found.room;
          $("#fDate").value = found.date;
          fStart.value = found.start;
          fDur.value = found.slots;
          $("#fTitle").value = found.title||"";
          $("#fDept").value = found.dept||"";
          $("#fOwner").value = found.owner||"";
          $("#fNote").value = found.note||"";

          $("#gcalBtn").onclick = ()=> window.open(buildGCalUrl(found), "_blank");
          $("#icsBtn").onclick = ()=> downloadICS(`reservation_${found.id||"event"}.ics`, [makeICSEvent(found)]);
        }
      }else{
        state.editing = null;
      }

      $("#cancelBtn").onclick = closeModal;
      $("#saveBtn").onclick = saveReservation;
      $("#delBtn").onclick = deleteReservation;
      wrap.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      $("#modalWrap").style.display="none";
      $("#modalWrap").setAttribute("aria-hidden","true");
    }

    function saveReservation(){
      const room = $("#fRoom").value;
      const date = $("#fDate").value;
      const start = +$("#fStart").value;
      const slots = +$("#fDur").value;
      const title = $("#fTitle").value.trim();
      const dept = $("#fDept").value.trim();
      const owner = $("#fOwner").value.trim();
      const note = $("#fNote").value.trim();

      const key = toKey(date);
      const list = getDayList(key).slice();

      const resv = {
        id: state.editing || uid(),
        room, date, start, slots,
        title, dept, owner, note
      };
      if(overlaps(resv, list)){
        showToast("âš ï¸ ê°™ì€ ì‹œê°„ì— í•´ë‹¹ ë°©ì˜ ë‹¤ë¥¸ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      const idx = list.findIndex(x=>x.id===resv.id);
      if(idx>=0) list[idx]=resv; else list.push(resv);
      setDayList(key, list);
      closeModal();
      showToast("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      renderGrid();
    }

    function deleteReservation(){
      if(!state.editing) return;
      const date = $("#fDate").value;
      const key = toKey(date);
      const list = getDayList(key).slice();
      const idx = list.findIndex(x=>x.id===state.editing);
      if(idx>=0) list.splice(idx,1);
      setDayList(key, list);
      closeModal();
      showToast("ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      renderGrid();
    }

    function doExport(){
      const data = JSON.stringify(state.data, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "reservations.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("ğŸ’¾ JSON íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.");
    }
    function doImport(ev){
      const file = ev.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const obj = JSON.parse(e.target.result);
          if(typeof obj === "object"){
            state.data = obj;
            saveData(state.data);
            renderGrid();
            showToast("ğŸ“¥ JSONì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
          }else{
            showToast("í˜•ì‹ ì˜¤ë¥˜: JSON ê°ì²´ê°€ ì•„ë‹™ë‹ˆë‹¤.");
          }
        }catch(err){
          showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSONì´ ì•„ë‹™ë‹ˆë‹¤.");
        }
      };
      reader.readAsText(file);
      ev.target.value="";
    }

    function exportDayICS(){
      const key = toKey(ymd(state.date));
      const list = getDayList(key);
      if(!list.length){ showToast("ë‚´ë³´ë‚¼ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      const events = list.map(makeICSEvent);
      downloadICS(`reservations_${key}.ics`, events);
    }

    function div(cls=""){ const d=document.createElement("div"); if(cls) d.className=cls; return d; }

    function renderReservationElementWrapper(){}

    function renderReservationElement(r){
      const el = div("resv");
      const left = div();
      const startHM = fromSlotIndex(r.start);
      const endHM = fromSlotIndex(r.start + r.slots);
      left.innerHTML = `<div class="title">${escapeHtml(r.title||"(ì œëª© ì—†ìŒ)")}</div>
                        <small>${r.room} â€¢ ${fmtHM(startHM.h,startHM.m)} ~ ${fmtHM(endHM.h,endHM.m)}${r.dept ? " â€¢ "+escapeHtml(r.dept) : ""}${r.owner ? " â€¢ "+escapeHtml(r.owner) : ""}</small>`;
      const right = div();
      const editBtn = document.createElement("button"); editBtn.textContent="í¸ì§‘"; editBtn.className="ghost"; editBtn.style.padding="6px 8px";
      editBtn.addEventListener("click", (e)=>{ e.stopPropagation(); openModal(null, r.id); });
      const gcalBtn = document.createElement("button"); gcalBtn.textContent="GCal"; gcalBtn.className="ghost"; gcalBtn.style.padding="6px 8px";
      gcalBtn.addEventListener("click", (e)=>{ e.stopPropagation(); window.open(buildGCalUrl(r), "_blank"); });
      const icsBtn = document.createElement("button"); icsBtn.textContent="ICS"; icsBtn.className="ghost"; icsBtn.style.padding="6px 8px";
      icsBtn.addEventListener("click", (e)=>{ e.stopPropagation(); downloadICS(`reservation_${r.id||"event"}.ics`, [makeICSEvent(r)]); });
      right.appendChild(gcalBtn);
      right.appendChild(icsBtn);
      right.appendChild(editBtn);
      el.appendChild(left); el.appendChild(right);
      el.addEventListener("click", (e)=>{ e.stopPropagation(); openModal(null, r.id); });
      return el;
    }

    initControls();
    renderGrid();
  </script>
</body>
</html>
